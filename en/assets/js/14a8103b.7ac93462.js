"use strict";(globalThis.webpackChunkdocs_site=globalThis.webpackChunkdocs_site||[]).push([[5211],{91697:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"plugin/examples","title":"\u5b8c\u6574\u793a\u4f8b","description":"\u672c\u6587\u6863\u63d0\u4f9b\u5404\u53ef\u63d2\u70b9\u7684\u5b8c\u6574\u63d2\u4ef6\u5b9e\u73b0\u793a\u4f8b\uff0c\u5305\u542b Python \u548c Node.js \u4e24\u79cd\u8bed\u8a00\u7248\u672c\u3002","source":"@site/docs/plugin/examples.md","sourceDirName":"plugin","slug":"/plugin/examples","permalink":"/en/plugin/examples","draft":false,"unlisted":false,"editUrl":"https://github.com/tgoai/tgo/edit/main/docs-site/docs/plugin/examples.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"id":"examples","title":"\u5b8c\u6574\u793a\u4f8b","sidebar_position":6},"sidebar":"pluginSidebar","previous":{"title":"\u6a21\u7248\u89c4\u8303","permalink":"/en/plugin/templates"}}');var i=t(74848),r=t(28453);const a={id:"examples",title:"\u5b8c\u6574\u793a\u4f8b",sidebar_position:6},o="\u5b8c\u6574\u793a\u4f8b",l={},c=[{value:"\u793a\u4f8b\u4e00\uff1aCRM \u5ba2\u6237\u4fe1\u606f\u63d2\u4ef6",id:"\u793a\u4f8b\u4e00crm-\u5ba2\u6237\u4fe1\u606f\u63d2\u4ef6",level:2},{value:"Python \u5b9e\u73b0",id:"python-\u5b9e\u73b0",level:3},{value:"Node.js \u5b9e\u73b0",id:"nodejs-\u5b9e\u73b0",level:3},{value:"\u793a\u4f8b\u4e8c\uff1a\u5feb\u6377\u56de\u590d\u63d2\u4ef6",id:"\u793a\u4f8b\u4e8c\u5feb\u6377\u56de\u590d\u63d2\u4ef6",level:2},{value:"Python \u5b9e\u73b0",id:"python-\u5b9e\u73b0-1",level:3},{value:"\u793a\u4f8b\u4e09\uff1a\u7b2c\u4e09\u65b9\u5e73\u53f0\u63a5\u5165\u63d2\u4ef6",id:"\u793a\u4f8b\u4e09\u7b2c\u4e09\u65b9\u5e73\u53f0\u63a5\u5165\u63d2\u4ef6",level:2},{value:"Python \u5b9e\u73b0",id:"python-\u5b9e\u73b0-2",level:3},{value:"\u793a\u4f8b\u56db\uff1aiframe \u5e94\u7528\u63d2\u4ef6",id:"\u793a\u4f8b\u56dbiframe-\u5e94\u7528\u63d2\u4ef6",level:2},{value:"Python \u5b9e\u73b0",id:"python-\u5b9e\u73b0-3",level:3},{value:"\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b",id:"\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b",level:2},{value:"plugin.json",id:"pluginjson",level:3},{value:"\u6d4b\u8bd5\u811a\u672c",id:"\u6d4b\u8bd5\u811a\u672c",level:2},{value:"test_server.py",id:"test_serverpy",level:3},{value:"\u4e0b\u4e00\u6b65",id:"\u4e0b\u4e00\u6b65",level:2}];function d(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"\u5b8c\u6574\u793a\u4f8b",children:"\u5b8c\u6574\u793a\u4f8b"})}),"\n",(0,i.jsx)(e.p,{children:"\u672c\u6587\u6863\u63d0\u4f9b\u5404\u53ef\u63d2\u70b9\u7684\u5b8c\u6574\u63d2\u4ef6\u5b9e\u73b0\u793a\u4f8b\uff0c\u5305\u542b Python \u548c Node.js \u4e24\u79cd\u8bed\u8a00\u7248\u672c\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u793a\u4f8b\u4e00crm-\u5ba2\u6237\u4fe1\u606f\u63d2\u4ef6",children:"\u793a\u4f8b\u4e00\uff1aCRM \u5ba2\u6237\u4fe1\u606f\u63d2\u4ef6"}),"\n",(0,i.jsx)(e.p,{children:"\u4e00\u4e2a\u5b8c\u6574\u7684\u8bbf\u5ba2\u9762\u677f\u63d2\u4ef6\uff0c\u5c55\u793a\u5ba2\u6237\u7684 CRM \u4fe1\u606f\u3001\u8ba2\u5355\u8bb0\u5f55\u548c\u64cd\u4f5c\u6309\u94ae\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"python-\u5b9e\u73b0",children:"Python \u5b9e\u73b0"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'#!/usr/bin/env python3\n"""\nTGO \u63d2\u4ef6\u793a\u4f8b - CRM \u5ba2\u6237\u4fe1\u606f\n\u5c55\u793a\u5ba2\u6237\u6863\u6848\u3001\u8ba2\u5355\u8bb0\u5f55\u3001\u4f1a\u5458\u4fe1\u606f\n\u901a\u8fc7 Unix Socket \u4e0e\u5bbf\u4e3b\u7a0b\u5e8f\u901a\u8baf\n"""\nimport os\nimport sys\nimport json\nimport socket\nimport struct\nimport signal\nimport logging\nfrom datetime import datetime\nfrom typing import Optional, Dict, Any\n\n# \u914d\u7f6e\u65e5\u5fd7\u8f93\u51fa\u5230 stderr\nlogging.basicConfig(\n    level=logging.DEBUG,\n    format=\'[%(levelname)s] %(message)s\',\n    stream=sys.stderr\n)\nlogger = logging.getLogger(__name__)\n\n\nclass TGOPlugin:\n    """TGO \u63d2\u4ef6\u57fa\u7c7b - \u5ba2\u6237\u7aef\u6a21\u5f0f"""\n    \n    # TGO \u5bbf\u4e3b\u7a0b\u5e8f\u7684 Socket \u8def\u5f84\n    TGO_SOCKET_PATH = "/var/run/tgo/tgo.sock"\n    \n    def __init__(self, plugin_name: str, version: str = "1.0.0"):\n        self.plugin_name = plugin_name\n        self.version = version\n        self.running = True\n        self.sock = None\n    \n    def connect(self):\n        """\u8fde\u63a5\u5230 TGO \u5bbf\u4e3b\u7a0b\u5e8f"""\n        self.sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)\n        self.sock.connect(self.TGO_SOCKET_PATH)\n        logger.info(f"\u5df2\u8fde\u63a5\u5230 TGO: {self.TGO_SOCKET_PATH}")\n    \n    def disconnect(self):\n        """\u65ad\u5f00\u8fde\u63a5"""\n        if self.sock:\n            self.sock.close()\n            self.sock = None\n    \n    def recv_message(self) -> Optional[Dict[str, Any]]:\n        """\u4ece Socket \u63a5\u6536\u6d88\u606f"""\n        try:\n            length_bytes = self._recv_exact(4)\n            if not length_bytes:\n                return None\n            length = struct.unpack(\'>I\', length_bytes)[0]\n            json_bytes = self._recv_exact(length)\n            if not json_bytes:\n                return None\n            return json.loads(json_bytes.decode(\'utf-8\'))\n        except Exception as e:\n            logger.error(f"\u63a5\u6536\u6d88\u606f\u9519\u8bef: {e}")\n            return None\n    \n    def _recv_exact(self, n: int) -> Optional[bytes]:\n        """\u7cbe\u786e\u63a5\u6536 n \u5b57\u8282"""\n        data = b\'\'\n        while len(data) < n:\n            chunk = self.sock.recv(n - len(data))\n            if not chunk:\n                return None\n            data += chunk\n        return data\n    \n    def send_message(self, message: Dict[str, Any]):\n        """\u5411 Socket \u53d1\u9001\u6d88\u606f"""\n        json_bytes = json.dumps(message, ensure_ascii=False).encode(\'utf-8\')\n        length = struct.pack(\'>I\', len(json_bytes))\n        self.sock.sendall(length + json_bytes)\n    \n    def send_response(self, request_id: Any, result: Dict[str, Any]):\n        """\u53d1\u9001\u6210\u529f\u54cd\u5e94"""\n        self.send_message({\n            "jsonrpc": "2.0",\n            "id": request_id,\n            "result": result\n        })\n    \n    def send_error(self, request_id: Any, code: int, message: str):\n        """\u53d1\u9001\u9519\u8bef\u54cd\u5e94"""\n        self.send_message({\n            "jsonrpc": "2.0",\n            "id": request_id,\n            "error": {"code": code, "message": message}\n        })\n    \n    def get_capabilities(self) -> list:\n        """\u5b50\u7c7b\u5b9e\u73b0\uff1a\u8fd4\u56de\u63d2\u4ef6\u80fd\u529b\u58f0\u660e"""\n        raise NotImplementedError("\u5b50\u7c7b\u5fc5\u987b\u5b9e\u73b0 get_capabilities \u65b9\u6cd5")\n    \n    def register(self) -> bool:\n        """\u5411\u5bbf\u4e3b\u6ce8\u518c\u63d2\u4ef6"""\n        self.send_message({\n            "jsonrpc": "2.0",\n            "id": 1,\n            "method": "register",\n            "params": {\n                "name": self.plugin_name,\n                "version": self.version,\n                "capabilities": self.get_capabilities()\n            }\n        })\n        \n        response = self.recv_message()\n        if response and response.get("result", {}).get("success"):\n            logger.info("\u63d2\u4ef6\u6ce8\u518c\u6210\u529f")\n            return True\n        else:\n            logger.error(f"\u63d2\u4ef6\u6ce8\u518c\u5931\u8d25: {response}")\n            return False\n    \n    def run(self):\n        """\u63d2\u4ef6\u4e3b\u5faa\u73af"""\n        # \u4fe1\u53f7\u5904\u7406\n        def handle_signal(signum, frame):\n            self.running = False\n            self.disconnect()\n            sys.exit(0)\n        \n        signal.signal(signal.SIGTERM, handle_signal)\n        signal.signal(signal.SIGINT, handle_signal)\n        \n        try:\n            # \u8fde\u63a5\u5e76\u6ce8\u518c\n            self.connect()\n            if not self.register():\n                sys.exit(1)\n            \n            # \u4e3b\u5faa\u73af\n            while self.running:\n                request = self.recv_message()\n                if request is None:\n                    logger.info("\u8fde\u63a5\u5df2\u65ad\u5f00")\n                    break\n                \n                method = request.get("method")\n                request_id = request.get("id")\n                params = request.get("params", {})\n                \n                logger.debug(f"\u6536\u5230\u8bf7\u6c42: {method}")\n                \n                # \u5904\u7406 shutdown\n                if method == "shutdown":\n                    self.send_response(request_id, {"success": True})\n                    break\n                \n                try:\n                    handler = getattr(self, f"handle_{method.replace(\'/\', \'_\')}", None)\n                    if handler:\n                        result = handler(params)\n                        self.send_response(request_id, result)\n                    else:\n                        self.send_error(request_id, -32601, f"Method not found: {method}")\n                except Exception as e:\n                    logger.exception(f"\u5904\u7406\u8bf7\u6c42\u65f6\u51fa\u9519: {e}")\n                    self.send_error(request_id, -32603, str(e))\n        \n        except ConnectionRefusedError:\n            logger.error(f"\u65e0\u6cd5\u8fde\u63a5\u5230 TGO: {self.TGO_SOCKET_PATH}")\n            sys.exit(1)\n        finally:\n            self.disconnect()\n\n\nclass CRMPlugin(TGOPlugin):\n    """CRM \u5ba2\u6237\u4fe1\u606f\u63d2\u4ef6"""\n    \n    def __init__(self):\n        super().__init__("crm-customer-info", "1.0.0")\n    \n    def get_capabilities(self) -> list:\n        """\u8fd4\u56de\u63d2\u4ef6\u80fd\u529b\u58f0\u660e"""\n        return [\n            {\n                "type": "visitor_panel",\n                "title": "\u5ba2\u6237\u6863\u6848",\n                "icon": "user",\n                "priority": 1\n            },\n            {\n                "type": "visitor_panel",\n                "title": "\u8ba2\u5355\u8bb0\u5f55",\n                "icon": "shopping-cart",\n                "priority": 2\n            },\n            {\n                "type": "chat_toolbar",\n                "title": "CRM \u64cd\u4f5c",\n                "icon": "database",\n                "tooltip": "CRM \u5feb\u6377\u64cd\u4f5c"\n            }\n        ]\n    \n    def handle_visitor_panel_render(self, params: Dict) -> Dict:\n        """\u6e32\u67d3\u8bbf\u5ba2\u9762\u677f"""\n        visitor = params.get("visitor", {})\n        metadata = visitor.get("metadata", {})\n        \n        # \u6839\u636e metadata \u4e2d\u7684 user_id \u83b7\u53d6 CRM \u6570\u636e\n        user_id = metadata.get("user_id")\n        \n        if not user_id:\n            return {\n                "template": "empty",\n                "data": {\n                    "icon": "user-x",\n                    "title": "\u672a\u5173\u8054\u5ba2\u6237",\n                    "description": "\u8be5\u8bbf\u5ba2\u5c1a\u672a\u4e0e CRM \u5ba2\u6237\u5173\u8054",\n                    "action": {\n                        "id": "link_customer",\n                        "label": "\u5173\u8054\u5ba2\u6237"\n                    }\n                }\n            }\n        \n        # \u6a21\u62df\u4ece CRM \u83b7\u53d6\u5ba2\u6237\u6570\u636e\n        customer = self._get_customer_data(user_id)\n        \n        # \u8fd4\u56de\u7ec4\u5408\u6a21\u7248\n        return {\n            "template": "group",\n            "data": {\n                "items": [\n                    # \u7edf\u8ba1\u6570\u636e\n                    {\n                        "template": "stats",\n                        "data": {\n                            "items": [\n                                {\n                                    "label": "\u4f1a\u8bdd\u6b21\u6570",\n                                    "value": str(customer["session_count"]),\n                                    "icon": "message-square"\n                                },\n                                {\n                                    "label": "\u7d2f\u8ba1\u6d88\u8d39",\n                                    "value": customer["total_spent"],\n                                    "icon": "dollar-sign"\n                                },\n                                {\n                                    "label": "\u6ee1\u610f\u5ea6",\n                                    "value": customer["satisfaction"],\n                                    "icon": "smile",\n                                    "color": "green"\n                                }\n                            ]\n                        }\n                    },\n                    # \u5ba2\u6237\u4fe1\u606f\n                    {\n                        "template": "key_value",\n                        "data": {\n                            "title": "\u5ba2\u6237\u4fe1\u606f",\n                            "items": [\n                                {\n                                    "label": "\u5ba2\u6237ID",\n                                    "value": customer["id"],\n                                    "copyable": True\n                                },\n                                {\n                                    "label": "\u59d3\u540d",\n                                    "value": customer["name"]\n                                },\n                                {\n                                    "label": "\u4f1a\u5458\u7b49\u7ea7",\n                                    "value": customer["vip_level"],\n                                    "icon": "crown",\n                                    "color": "#FFD700"\n                                },\n                                {\n                                    "label": "\u6ce8\u518c\u65f6\u95f4",\n                                    "value": customer["registered_at"],\n                                    "type": "date"\n                                },\n                                {\n                                    "label": "\u624b\u673a\u53f7",\n                                    "value": customer["phone"],\n                                    "copyable": True\n                                }\n                            ]\n                        }\n                    },\n                    # \u6807\u7b7e\n                    {\n                        "template": "text",\n                        "data": {\n                            "text": " ".join([f"#{tag}" for tag in customer["tags"]]),\n                            "type": "info"\n                        }\n                    },\n                    # \u6700\u8fd1\u8ba2\u5355\n                    {\n                        "template": "table",\n                        "data": {\n                            "title": "\u6700\u8fd1\u8ba2\u5355",\n                            "columns": [\n                                {"key": "order_id", "label": "\u8ba2\u5355\u53f7"},\n                                {"key": "amount", "label": "\u91d1\u989d", "align": "right"},\n                                {"key": "status", "label": "\u72b6\u6001", "type": "badge"}\n                            ],\n                            "rows": customer["recent_orders"],\n                            "row_click_action": "view_order"\n                        }\n                    },\n                    # \u64cd\u4f5c\u6309\u94ae\n                    {\n                        "template": "action",\n                        "data": {\n                            "buttons": [\n                                {\n                                    "id": "view_in_crm",\n                                    "label": "\u5728 CRM \u4e2d\u67e5\u770b",\n                                    "icon": "external-link",\n                                    "type": "primary"\n                                },\n                                {\n                                    "id": "add_tag",\n                                    "label": "\u6dfb\u52a0\u6807\u7b7e",\n                                    "icon": "tag",\n                                    "type": "default"\n                                }\n                            ]\n                        }\n                    }\n                ]\n            }\n        }\n    \n    def handle_visitor_panel_action(self, params: Dict) -> Dict:\n        """\u5904\u7406\u8bbf\u5ba2\u9762\u677f\u6309\u94ae\u70b9\u51fb"""\n        action_id = params.get("action_id")\n        visitor_id = params.get("visitor_id")\n        \n        if action_id == "view_in_crm":\n            # \u8fd4\u56de\u6253\u5f00\u94fe\u63a5\u52a8\u4f5c\n            return {\n                "action": "open_url",\n                "data": {\n                    "url": f"https://crm.example.com/customers/{visitor_id}",\n                    "target": "_blank"\n                }\n            }\n        elif action_id == "link_customer":\n            # \u8fd4\u56de\u8868\u5355\u5f39\u7a97\n            return {\n                "action": "show_modal",\n                "data": {\n                    "title": "\u5173\u8054\u5ba2\u6237",\n                    "template": "form",\n                    "fields": [\n                        {\n                            "name": "customer_id",\n                            "label": "\u5ba2\u6237ID",\n                            "type": "text",\n                            "required": True,\n                            "placeholder": "\u8bf7\u8f93\u5165 CRM \u5ba2\u6237ID"\n                        }\n                    ],\n                    "submit_action": "do_link_customer"\n                }\n            }\n        elif action_id == "add_tag":\n            return {\n                "action": "show_modal",\n                "data": {\n                    "title": "\u6dfb\u52a0\u6807\u7b7e",\n                    "template": "form",\n                    "fields": [\n                        {\n                            "name": "tags",\n                            "label": "\u6807\u7b7e",\n                            "type": "checkbox",\n                            "options": [\n                                {"value": "vip", "label": "VIP\u5ba2\u6237"},\n                                {"value": "enterprise", "label": "\u4f01\u4e1a\u5ba2\u6237"},\n                                {"value": "potential", "label": "\u6f5c\u5728\u5ba2\u6237"},\n                                {"value": "complaint", "label": "\u6295\u8bc9\u5ba2\u6237"}\n                            ]\n                        }\n                    ],\n                    "submit_action": "do_add_tag"\n                }\n            }\n        \n        return {"success": True}\n    \n    def handle_chat_toolbar_action(self, params: Dict) -> Dict:\n        """\u5904\u7406\u804a\u5929\u5de5\u5177\u680f\u6309\u94ae\u70b9\u51fb"""\n        return {\n            "action": "show_modal",\n            "data": {\n                "title": "CRM \u64cd\u4f5c",\n                "template": "list",\n                "items": [\n                    {"id": "create_ticket", "text": "\u521b\u5efa\u5de5\u5355", "icon": "file-plus"},\n                    {"id": "add_note", "text": "\u6dfb\u52a0\u5907\u6ce8", "icon": "edit"},\n                    {"id": "set_priority", "text": "\u8bbe\u7f6e\u4f18\u5148\u7ea7", "icon": "flag"},\n                    {"id": "assign_agent", "text": "\u8f6c\u63a5\u5ba2\u670d", "icon": "user-plus"}\n                ],\n                "searchable": False\n            }\n        }\n    \n    def handle_chat_toolbar_submit(self, params: Dict) -> Dict:\n        """\u5904\u7406\u5de5\u5177\u680f\u8868\u5355\u63d0\u4ea4"""\n        action_id = params.get("action_id")\n        form_data = params.get("form_data", {})\n        \n        if action_id == "create_ticket":\n            # \u6a21\u62df\u521b\u5efa\u5de5\u5355\n            ticket_id = "TK-" + datetime.now().strftime("%Y%m%d%H%M%S")\n            return {\n                "action": "notify",\n                "data": {\n                    "type": "success",\n                    "message": f"\u5de5\u5355\u521b\u5efa\u6210\u529f\uff01\u5de5\u5355\u53f7: {ticket_id}"\n                }\n            }\n        \n        return {"success": True}\n    \n    def _get_customer_data(self, user_id: str) -> Dict:\n        """\u6a21\u62df\u83b7\u53d6 CRM \u5ba2\u6237\u6570\u636e"""\n        # \u5b9e\u9645\u573a\u666f\u4e2d\uff0c\u8fd9\u91cc\u5e94\u8be5\u8c03\u7528 CRM API\n        return {\n            "id": user_id,\n            "name": "\u5f20\u4e09",\n            "phone": "138****1234",\n            "email": "zhangsan@example.com",\n            "vip_level": "\u9ec4\u91d1\u4f1a\u5458",\n            "registered_at": "2023-06-15",\n            "session_count": 23,\n            "total_spent": "\xa512,580",\n            "satisfaction": "98%",\n            "tags": ["VIP", "\u4f01\u4e1a\u5ba2\u6237", "\u6d3b\u8dc3"],\n            "recent_orders": [\n                {\n                    "order_id": "ORD-2024001",\n                    "amount": "\xa5299.00",\n                    "status": {"text": "\u5df2\u5b8c\u6210", "color": "green"}\n                },\n                {\n                    "order_id": "ORD-2024002",\n                    "amount": "\xa5599.00",\n                    "status": {"text": "\u5f85\u53d1\u8d27", "color": "orange"}\n                },\n                {\n                    "order_id": "ORD-2024003",\n                    "amount": "\xa51,299.00",\n                    "status": {"text": "\u5df2\u53d6\u6d88", "color": "gray"}\n                }\n            ]\n        }\n\n\nif __name__ == "__main__":\n    plugin = CRMPlugin("crm-customer-info")\n    plugin.run()\n'})}),"\n",(0,i.jsx)(e.h3,{id:"nodejs-\u5b9e\u73b0",children:"Node.js \u5b9e\u73b0"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"#!/usr/bin/env node\n/**\n * TGO \u63d2\u4ef6\u793a\u4f8b - CRM \u5ba2\u6237\u4fe1\u606f\n * \u63d2\u4ef6\u4f5c\u4e3a\u5ba2\u6237\u7aef\uff0c\u8fde\u63a5\u5230 TGO \u5bbf\u4e3b\u7a0b\u5e8f\n */\nconst net = require('net');\n\n// TGO \u5bbf\u4e3b\u7a0b\u5e8f\u7684 Socket \u8def\u5f84\nconst TGO_SOCKET_PATH = '/var/run/tgo/tgo.sock';\n\n// \u65e5\u5fd7\u8f93\u51fa\u5230 stderr\nfunction log(level, message) {\n  console.error(`[${level}] ${message}`);\n}\n\nclass TGOPlugin {\n  constructor(pluginName, version = '1.0.0') {\n    this.pluginName = pluginName;\n    this.version = version;\n    this.running = true;\n    this.client = null;\n    this.buffer = Buffer.alloc(0);\n    this.registered = false;\n  }\n\n  /**\n   * \u89e3\u6790\u6d88\u606f\uff08\u957f\u5ea6\u524d\u7f00 + JSON\uff09\n   */\n  parseMessages(buffer) {\n    const messages = [];\n    let offset = 0;\n    \n    while (offset + 4 <= buffer.length) {\n      const length = buffer.readUInt32BE(offset);\n      if (offset + 4 + length > buffer.length) break;\n      \n      const jsonStr = buffer.slice(offset + 4, offset + 4 + length).toString('utf-8');\n      messages.push(JSON.parse(jsonStr));\n      offset += 4 + length;\n    }\n    \n    return { messages, remaining: buffer.slice(offset) };\n  }\n\n  /**\n   * \u5e8f\u5217\u5316\u6d88\u606f\n   */\n  serializeMessage(data) {\n    const jsonBuffer = Buffer.from(JSON.stringify(data), 'utf-8');\n    const lengthBuffer = Buffer.alloc(4);\n    lengthBuffer.writeUInt32BE(jsonBuffer.length, 0);\n    return Buffer.concat([lengthBuffer, jsonBuffer]);\n  }\n\n  sendMessage(message) {\n    this.client.write(this.serializeMessage(message));\n  }\n\n  sendResponse(requestId, result) {\n    this.sendMessage({ jsonrpc: '2.0', id: requestId, result });\n  }\n\n  sendError(requestId, code, message) {\n    this.sendMessage({\n      jsonrpc: '2.0',\n      id: requestId,\n      error: { code, message }\n    });\n  }\n\n  /**\n   * \u5b50\u7c7b\u5b9e\u73b0\uff1a\u8fd4\u56de\u63d2\u4ef6\u80fd\u529b\u58f0\u660e\n   */\n  getCapabilities() {\n    throw new Error('\u5b50\u7c7b\u5fc5\u987b\u5b9e\u73b0 getCapabilities \u65b9\u6cd5');\n  }\n\n  /**\n   * \u6ce8\u518c\u63d2\u4ef6\n   */\n  register() {\n    this.sendMessage({\n      jsonrpc: '2.0',\n      id: 1,\n      method: 'register',\n      params: {\n        name: this.pluginName,\n        version: this.version,\n        capabilities: this.getCapabilities()\n      }\n    });\n  }\n\n  run() {\n    this.client = net.createConnection(TGO_SOCKET_PATH, () => {\n      log('INFO', `\u5df2\u8fde\u63a5\u5230 TGO: ${TGO_SOCKET_PATH}`);\n      this.register();\n    });\n\n    this.client.on('data', async (data) => {\n      this.buffer = Buffer.concat([this.buffer, data]);\n      const { messages, remaining } = this.parseMessages(this.buffer);\n      this.buffer = remaining;\n\n      for (const message of messages) {\n        // \u5904\u7406\u6ce8\u518c\u54cd\u5e94\n        if (!this.registered && message.result?.success) {\n          log('INFO', '\u63d2\u4ef6\u6ce8\u518c\u6210\u529f');\n          this.registered = true;\n          continue;\n        }\n\n        const { method, id, params = {} } = message;\n        \n        // \u5904\u7406 shutdown\n        if (method === 'shutdown') {\n          this.sendResponse(id, { success: true });\n          this.client.end();\n          return;\n        }\n\n        // \u5904\u7406\u4e1a\u52a1\u8bf7\u6c42\n        if (method) {\n          log('DEBUG', `\u6536\u5230\u8bf7\u6c42: ${method}`);\n          try {\n            const handlerName = `handle_${method.replace(/\\//g, '_')}`;\n            if (typeof this[handlerName] === 'function') {\n              const result = await this[handlerName](params);\n              this.sendResponse(id, result);\n            } else {\n              this.sendError(id, -32601, `Method not found: ${method}`);\n            }\n          } catch (error) {\n            log('ERROR', `\u5904\u7406\u8bf7\u6c42\u65f6\u51fa\u9519: ${error.message}`);\n            this.sendError(id, -32603, error.message);\n          }\n        }\n      }\n    });\n\n    this.client.on('error', (err) => {\n      log('ERROR', `\u8fde\u63a5\u9519\u8bef: ${err.message}`);\n      process.exit(1);\n    });\n\n    this.client.on('close', () => {\n      log('INFO', '\u8fde\u63a5\u5df2\u5173\u95ed');\n      process.exit(0);\n    });\n\n    process.on('SIGTERM', () => {\n      this.client.end();\n      process.exit(0);\n    });\n  }\n}\n\nclass CRMPlugin extends TGOPlugin {\n  constructor() {\n    super('crm-customer-info', '1.0.0');\n  }\n\n  getCapabilities() {\n    return [\n      {\n        type: 'visitor_panel',\n        title: '\u5ba2\u6237\u6863\u6848',\n        icon: 'user',\n        priority: 1\n      },\n      {\n        type: 'visitor_panel',\n        title: '\u8ba2\u5355\u8bb0\u5f55',\n        icon: 'shopping-cart',\n        priority: 2\n      },\n      {\n        type: 'chat_toolbar',\n        title: 'CRM \u64cd\u4f5c',\n        icon: 'database',\n        tooltip: 'CRM \u5feb\u6377\u64cd\u4f5c'\n      }\n    ];\n  }\n\n  handle_shutdown(params) {\n    this.running = false;\n    setTimeout(() => process.exit(0), 100);\n    return { success: true };\n  }\n\n  handle_ping(params) {\n    return {\n      pong: true,\n      timestamp: Date.now()\n    };\n  }\n\n  handle_visitor_panel_render(params) {\n    const visitor = params.visitor || {};\n    const metadata = visitor.metadata || {};\n    const userId = metadata.user_id;\n\n    if (!userId) {\n      return {\n        template: 'empty',\n        data: {\n          icon: 'user-x',\n          title: '\u672a\u5173\u8054\u5ba2\u6237',\n          description: '\u8be5\u8bbf\u5ba2\u5c1a\u672a\u4e0e CRM \u5ba2\u6237\u5173\u8054',\n          action: {\n            id: 'link_customer',\n            label: '\u5173\u8054\u5ba2\u6237'\n          }\n        }\n      };\n    }\n\n    const customer = this._getCustomerData(userId);\n\n    return {\n      template: 'group',\n      data: {\n        items: [\n          {\n            template: 'stats',\n            data: {\n              items: [\n                { label: '\u4f1a\u8bdd\u6b21\u6570', value: String(customer.session_count), icon: 'message-square' },\n                { label: '\u7d2f\u8ba1\u6d88\u8d39', value: customer.total_spent, icon: 'dollar-sign' },\n                { label: '\u6ee1\u610f\u5ea6', value: customer.satisfaction, icon: 'smile', color: 'green' }\n              ]\n            }\n          },\n          {\n            template: 'key_value',\n            data: {\n              title: '\u5ba2\u6237\u4fe1\u606f',\n              items: [\n                { label: '\u5ba2\u6237ID', value: customer.id, copyable: true },\n                { label: '\u59d3\u540d', value: customer.name },\n                { label: '\u4f1a\u5458\u7b49\u7ea7', value: customer.vip_level, icon: 'crown', color: '#FFD700' },\n                { label: '\u6ce8\u518c\u65f6\u95f4', value: customer.registered_at, type: 'date' },\n                { label: '\u624b\u673a\u53f7', value: customer.phone, copyable: true }\n              ]\n            }\n          },\n          {\n            template: 'table',\n            data: {\n              title: '\u6700\u8fd1\u8ba2\u5355',\n              columns: [\n                { key: 'order_id', label: '\u8ba2\u5355\u53f7' },\n                { key: 'amount', label: '\u91d1\u989d', align: 'right' },\n                { key: 'status', label: '\u72b6\u6001', type: 'badge' }\n              ],\n              rows: customer.recent_orders\n            }\n          },\n          {\n            template: 'action',\n            data: {\n              buttons: [\n                { id: 'view_in_crm', label: '\u5728 CRM \u4e2d\u67e5\u770b', icon: 'external-link', type: 'primary' },\n                { id: 'add_tag', label: '\u6dfb\u52a0\u6807\u7b7e', icon: 'tag', type: 'default' }\n              ]\n            }\n          }\n        ]\n      }\n    };\n  }\n\n  handle_chat_toolbar_action(params) {\n    return {\n      action: 'show_modal',\n      data: {\n        title: 'CRM \u64cd\u4f5c',\n        template: 'list',\n        items: [\n          { id: 'create_ticket', text: '\u521b\u5efa\u5de5\u5355', icon: 'file-plus' },\n          { id: 'add_note', text: '\u6dfb\u52a0\u5907\u6ce8', icon: 'edit' },\n          { id: 'set_priority', text: '\u8bbe\u7f6e\u4f18\u5148\u7ea7', icon: 'flag' },\n          { id: 'assign_agent', text: '\u8f6c\u63a5\u5ba2\u670d', icon: 'user-plus' }\n        ]\n      }\n    };\n  }\n\n  _getCustomerData(userId) {\n    return {\n      id: userId,\n      name: '\u5f20\u4e09',\n      phone: '138****1234',\n      vip_level: '\u9ec4\u91d1\u4f1a\u5458',\n      registered_at: '2023-06-15',\n      session_count: 23,\n      total_spent: '\xa512,580',\n      satisfaction: '98%',\n      tags: ['VIP', '\u4f01\u4e1a\u5ba2\u6237'],\n      recent_orders: [\n        { order_id: 'ORD-2024001', amount: '\xa5299.00', status: { text: '\u5df2\u5b8c\u6210', color: 'green' } },\n        { order_id: 'ORD-2024002', amount: '\xa5599.00', status: { text: '\u5f85\u53d1\u8d27', color: 'orange' } }\n      ]\n    };\n  }\n}\n\nconst plugin = new CRMPlugin('crm-customer-info');\nplugin.run();\n"})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u793a\u4f8b\u4e8c\u5feb\u6377\u56de\u590d\u63d2\u4ef6",children:"\u793a\u4f8b\u4e8c\uff1a\u5feb\u6377\u56de\u590d\u63d2\u4ef6"}),"\n",(0,i.jsx)(e.p,{children:"\u4e00\u4e2a\u804a\u5929\u5de5\u5177\u680f\u63d2\u4ef6\uff0c\u63d0\u4f9b\u5e38\u7528\u56de\u590d\u6a21\u677f\u548c AI \u8f85\u52a9\u56de\u590d\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"python-\u5b9e\u73b0-1",children:"Python \u5b9e\u73b0"}),"\n",(0,i.jsx)(e.admonition,{title:"\u7b80\u5316\u793a\u4f8b",type:"tip",children:(0,i.jsxs)(e.p,{children:["\u4ee5\u4e0b\u793a\u4f8b\u4f7f\u7528\u51fd\u6570\u5f0f\u98ce\u683c\u7f16\u5199\uff0c\u5b9e\u9645\u5e94\u7528\u4e2d\u5efa\u8bae\u53c2\u8003\u300c\u793a\u4f8b\u4e00\u300d\u4f7f\u7528 ",(0,i.jsx)(e.code,{children:"TGOPlugin"})," \u57fa\u7c7b\u6765\u5904\u7406 Socket \u8fde\u63a5\u548c\u6d88\u606f\u6536\u53d1\u3002"]})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'#!/usr/bin/env python3\n"""\nTGO \u63d2\u4ef6\u793a\u4f8b - \u5feb\u6377\u56de\u590d\n\u63d0\u4f9b\u5e38\u7528\u56de\u590d\u6a21\u677f\u548c AI \u8f85\u52a9\u56de\u590d\n\n\u6ce8\u610f\uff1a\u6b64\u4e3a\u7b80\u5316\u793a\u4f8b\uff0c\u7701\u7565\u4e86 Socket \u8fde\u63a5\u4ee3\u7801\n\u5b8c\u6574\u5b9e\u73b0\u8bf7\u53c2\u8003\u793a\u4f8b\u4e00\u7684 TGOPlugin \u57fa\u7c7b\n"""\n\n# \u9884\u8bbe\u56de\u590d\u6a21\u677f\nQUICK_REPLIES = {\n    "greeting": [\n        {"id": "g1", "text": "\u60a8\u597d\uff01\u611f\u8c22\u60a8\u7684\u54a8\u8be2\uff0c\u8bf7\u95ee\u6709\u4ec0\u4e48\u53ef\u4ee5\u5e2e\u60a8\uff1f"},\n        {"id": "g2", "text": "\u60a8\u597d\uff01\u5f88\u9ad8\u5174\u4e3a\u60a8\u670d\u52a1\uff0c\u8bf7\u95ee\u6709\u4ec0\u4e48\u95ee\u9898\u9700\u8981\u5e2e\u52a9\uff1f"},\n        {"id": "g3", "text": "\u6b22\u8fce\u54a8\u8be2\uff01\u8bf7\u95ee\u60a8\u9700\u8981\u4e86\u89e3\u4ec0\u4e48\uff1f"},\n    ],\n    "shipping": [\n        {"id": "s1", "text": "\u8ba2\u5355\u4e00\u822c\u5728\u4ed8\u6b3e\u540e 1-2 \u4e2a\u5de5\u4f5c\u65e5\u5185\u53d1\u8d27\u3002"},\n        {"id": "s2", "text": "\u5feb\u9012\u901a\u5e38 3-5 \u4e2a\u5de5\u4f5c\u65e5\u9001\u8fbe\uff0c\u504f\u8fdc\u5730\u533a\u53ef\u80fd\u7a0d\u6162\u3002"},\n        {"id": "s3", "text": "\u53d1\u8d27\u540e\u4f1a\u77ed\u4fe1\u901a\u77e5\u60a8\u7269\u6d41\u5355\u53f7\uff0c\u53ef\u5728\u8ba2\u5355\u8be6\u60c5\u4e2d\u67e5\u770b\u3002"},\n    ],\n    "return": [\n        {"id": "r1", "text": "\u6211\u4eec\u652f\u6301 7 \u5929\u65e0\u7406\u7531\u9000\u6362\u8d27\uff0c\u5546\u54c1\u9700\u4fdd\u6301\u539f\u5305\u88c5\u3002"},\n        {"id": "r2", "text": "\u9000\u8d27\u8bf7\u5148\u5728\u8ba2\u5355\u4e2d\u7533\u8bf7\uff0c\u5ba2\u670d\u5ba1\u6838\u540e\u4f1a\u63d0\u4f9b\u9000\u8d27\u5730\u5740\u3002"},\n        {"id": "r3", "text": "\u9000\u6b3e\u5c06\u5728\u6536\u5230\u9000\u8d27\u540e 3-5 \u4e2a\u5de5\u4f5c\u65e5\u5185\u539f\u8def\u8fd4\u56de\u3002"},\n    ],\n    "ending": [\n        {"id": "e1", "text": "\u611f\u8c22\u60a8\u7684\u54a8\u8be2\uff01\u5982\u6709\u5176\u4ed6\u95ee\u9898\u968f\u65f6\u8054\u7cfb\u6211\u4eec\u3002"},\n        {"id": "e2", "text": "\u795d\u60a8\u8d2d\u7269\u6109\u5feb\uff01\u5982\u6709\u95ee\u9898\u6b22\u8fce\u968f\u65f6\u54a8\u8be2\u3002"},\n        {"id": "e3", "text": "\u5f88\u9ad8\u5174\u80fd\u5e2e\u5230\u60a8\uff0c\u795d\u60a8\u751f\u6d3b\u6109\u5feb\uff01"},\n    ]\n}\n\n# \u63d2\u4ef6\u4fe1\u606f\nPLUGIN_NAME = "quick-reply"\nPLUGIN_VERSION = "1.0.0"\nPLUGIN_CAPABILITIES = [\n    {\n        "type": "chat_toolbar",\n        "title": "\u5feb\u6377\u56de\u590d",\n        "icon": "zap",\n        "tooltip": "\u9009\u62e9\u5e38\u7528\u56de\u590d\u6a21\u677f",\n        "shortcut": "Ctrl+Shift+R"\n    },\n    {\n        "type": "chat_toolbar",\n        "title": "AI \u8865\u5168",\n        "icon": "sparkles",\n        "tooltip": "AI \u8f85\u52a9\u56de\u590d",\n        "shortcut": "Ctrl+Shift+A"\n    }\n]\n\ndef handle_chat_toolbar_action(request):\n    params = request.get("params", {})\n    action_id = params.get("action_id", "quick_reply")\n    \n    if action_id == "ai_complete":\n        # AI \u8865\u5168 - \u6839\u636e\u4e0a\u4e0b\u6587\u751f\u6210\u56de\u590d\n        context = params.get("context", {})\n        input_text = context.get("input_text", "")\n        last_messages = context.get("last_messages", [])\n        \n        # \u8fd9\u91cc\u5e94\u8be5\u8c03\u7528 AI API\uff0c\u793a\u4f8b\u8fd4\u56de\u6a21\u62df\u7ed3\u679c\n        suggestions = generate_ai_suggestions(last_messages, input_text)\n        \n        return {\n            "jsonrpc": "2.0",\n            "id": request["id"],\n            "result": {\n                "action": "show_modal",\n                "data": {\n                    "title": "AI \u5efa\u8bae\u56de\u590d",\n                    "template": "list",\n                    "items": suggestions,\n                    "searchable": False\n                }\n            }\n        }\n    else:\n        # \u5feb\u6377\u56de\u590d - \u663e\u793a\u5206\u7c7b\u5217\u8868\n        return {\n            "jsonrpc": "2.0",\n            "id": request["id"],\n            "result": {\n                "action": "show_modal",\n                "data": {\n                    "title": "\u5feb\u6377\u56de\u590d",\n                    "template": "tabs",\n                    "items": [\n                        {\n                            "key": "greeting",\n                            "label": "\u95ee\u5019\u8bed",\n                            "icon": "hand",\n                            "content": {\n                                "template": "list",\n                                "data": {\n                                    "items": QUICK_REPLIES["greeting"]\n                                }\n                            }\n                        },\n                        {\n                            "key": "shipping",\n                            "label": "\u53d1\u8d27\u7269\u6d41",\n                            "icon": "truck",\n                            "content": {\n                                "template": "list",\n                                "data": {\n                                    "items": QUICK_REPLIES["shipping"]\n                                }\n                            }\n                        },\n                        {\n                            "key": "return",\n                            "label": "\u9000\u6362\u8d27",\n                            "icon": "refresh-ccw",\n                            "content": {\n                                "template": "list",\n                                "data": {\n                                    "items": QUICK_REPLIES["return"]\n                                }\n                            }\n                        },\n                        {\n                            "key": "ending",\n                            "label": "\u7ed3\u675f\u8bed",\n                            "icon": "check-circle",\n                            "content": {\n                                "template": "list",\n                                "data": {\n                                    "items": QUICK_REPLIES["ending"]\n                                }\n                            }\n                        }\n                    ],\n                    "default_tab": "greeting"\n                }\n            }\n        }\n\ndef handle_chat_toolbar_select(request):\n    """\u5904\u7406\u7528\u6237\u9009\u62e9\u5feb\u6377\u56de\u590d"""\n    params = request.get("params", {})\n    selected_id = params.get("selected_id")\n    \n    # \u67e5\u627e\u9009\u4e2d\u7684\u56de\u590d\u6587\u672c\n    text = None\n    for category, replies in QUICK_REPLIES.items():\n        for reply in replies:\n            if reply["id"] == selected_id:\n                text = reply["text"]\n                break\n    \n    if text:\n        return {\n            "jsonrpc": "2.0",\n            "id": request["id"],\n            "result": {\n                "action": "insert_text",\n                "data": {\n                    "text": text,\n                    "replace": False\n                }\n            }\n        }\n    \n    return {\n        "jsonrpc": "2.0",\n        "id": request["id"],\n        "result": {"success": True}\n    }\n\ndef generate_ai_suggestions(last_messages, input_text):\n    """\u6a21\u62df AI \u751f\u6210\u56de\u590d\u5efa\u8bae"""\n    # \u5b9e\u9645\u573a\u666f\u5e94\u8c03\u7528 LLM API\n    last_visitor_msg = ""\n    for msg in reversed(last_messages):\n        if msg.get("role") == "visitor":\n            last_visitor_msg = msg.get("content", "")\n            break\n    \n    # \u7b80\u5355\u7684\u5173\u952e\u8bcd\u5339\u914d\u6a21\u62df\n    if "\u53d1\u8d27" in last_visitor_msg or "\u7269\u6d41" in last_visitor_msg:\n        return [\n            {"id": "ai1", "text": "\u60a8\u7684\u8ba2\u5355\u9884\u8ba1\u660e\u5929\u53d1\u8d27\uff0c\u53d1\u8d27\u540e\u4f1a\u77ed\u4fe1\u901a\u77e5\u60a8\u7269\u6d41\u4fe1\u606f\u3002"},\n            {"id": "ai2", "text": "\u7269\u6d41\u4e00\u822c3-5\u5929\u9001\u8fbe\uff0c\u60a8\u53ef\u4ee5\u5728\u8ba2\u5355\u8be6\u60c5\u4e2d\u5b9e\u65f6\u8ffd\u8e2a\u3002"},\n        ]\n    elif "\u9000" in last_visitor_msg:\n        return [\n            {"id": "ai1", "text": "\u6211\u4eec\u652f\u63017\u5929\u65e0\u7406\u7531\u9000\u8d27\uff0c\u8bf7\u5728\u8ba2\u5355\u9875\u9762\u63d0\u4ea4\u9000\u8d27\u7533\u8bf7\u3002"},\n            {"id": "ai2", "text": "\u6536\u5230\u9000\u8d27\u540e\u6211\u4eec\u4f1a\u57283\u4e2a\u5de5\u4f5c\u65e5\u5185\u5b8c\u6210\u9000\u6b3e\u3002"},\n        ]\n    else:\n        return [\n            {"id": "ai1", "text": "\u611f\u8c22\u60a8\u7684\u54a8\u8be2\uff01\u8bf7\u95ee\u8fd8\u6709\u4ec0\u4e48\u53ef\u4ee5\u5e2e\u60a8\u7684\u5417\uff1f"},\n            {"id": "ai2", "text": "\u597d\u7684\uff0c\u6211\u5df2\u7ecf\u8bb0\u5f55\u4e0b\u6765\u4e86\uff0c\u8fd8\u6709\u5176\u4ed6\u95ee\u9898\u5417\uff1f"},\n        ]\n\n# \u4f7f\u7528 TGOPlugin \u57fa\u7c7b\u8fd0\u884c\uff08\u53c2\u8003\u793a\u4f8b\u4e00\uff09\n# \u4ee5\u4e0b\u4e3a\u5904\u7406\u51fd\u6570\uff0c\u9700\u914d\u5408 TGOPlugin \u57fa\u7c7b\u4f7f\u7528\n#\n# class QuickReplyPlugin(TGOPlugin):\n#     def __init__(self):\n#         super().__init__(PLUGIN_NAME, PLUGIN_VERSION)\n#     \n#     def get_capabilities(self):\n#         return PLUGIN_CAPABILITIES\n#     \n#     def handle_chat_toolbar_action(self, params):\n#         return handle_chat_toolbar_action({"params": params})["result"]\n#     \n#     def handle_chat_toolbar_select(self, params):\n#         return handle_chat_toolbar_select({"params": params})["result"]\n#\n# if __name__ == "__main__":\n#     plugin = QuickReplyPlugin()\n#     plugin.run()\n'})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u793a\u4f8b\u4e09\u7b2c\u4e09\u65b9\u5e73\u53f0\u63a5\u5165\u63d2\u4ef6",children:"\u793a\u4f8b\u4e09\uff1a\u7b2c\u4e09\u65b9\u5e73\u53f0\u63a5\u5165\u63d2\u4ef6"}),"\n",(0,i.jsx)(e.p,{children:"\u63a5\u5165\u81ea\u5b9a\u4e49 IM \u5e73\u53f0\u7684\u5b8c\u6574\u793a\u4f8b\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"python-\u5b9e\u73b0-2",children:"Python \u5b9e\u73b0"}),"\n",(0,i.jsx)(e.admonition,{title:"\u7b80\u5316\u793a\u4f8b",type:"tip",children:(0,i.jsxs)(e.p,{children:["\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u6838\u5fc3\u4e1a\u52a1\u903b\u8f91\uff0cSocket \u8fde\u63a5\u5904\u7406\u8bf7\u53c2\u8003\u300c\u793a\u4f8b\u4e00\u300d\u7684 ",(0,i.jsx)(e.code,{children:"TGOPlugin"})," \u57fa\u7c7b\u3002"]})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'#!/usr/bin/env python3\n"""\nTGO \u63d2\u4ef6\u793a\u4f8b - \u81ea\u5b9a\u4e49 IM \u5e73\u53f0\u63a5\u5165\n\u7ee7\u627f TGOPlugin \u57fa\u7c7b\u5b9e\u73b0\uff08\u5b8c\u6574\u57fa\u7c7b\u4ee3\u7801\u89c1\u793a\u4f8b\u4e00\uff09\n"""\nimport requests\nfrom typing import Dict, Any\n\n# \u63d2\u4ef6\u4fe1\u606f\nPLUGIN_NAME = "custom-im-integration"\nPLUGIN_VERSION = "1.0.0"\nPLUGIN_CAPABILITIES = [\n    {\n        "type": "channel_integration",\n        "channel_type": "custom_im",\n        "name": "\u81ea\u5b9a\u4e49IM",\n        "icon": "message-circle"\n    }\n]\n\nclass CustomIMPlugin:\n    """\u81ea\u5b9a\u4e49 IM \u5e73\u53f0\u63a5\u5165\u63d2\u4ef6\uff08\u4e1a\u52a1\u903b\u8f91\u90e8\u5206\uff09"""\n    \n    def __init__(self):\n        self.config = {}\n    \n    def handle_channel_integration_manifest(self, request: Dict) -> Dict:\n        return {\n            "jsonrpc": "2.0",\n            "id": request["id"],\n            "result": {\n                "channel_type": "custom_im",\n                "name": "\u81ea\u5b9a\u4e49IM\u5e73\u53f0",\n                "icon": "message-circle",\n                "description": "\u63a5\u5165\u81ea\u5b9a\u4e49 IM \u5e73\u53f0\uff0c\u652f\u6301\u6d88\u606f\u53cc\u5411\u540c\u6b65\u3001\u5df2\u8bfb\u56de\u6267\u7b49\u529f\u80fd\u3002",\n                \n                "config_schema": {\n                    "type": "object",\n                    "properties": {\n                        "api_endpoint": {\n                            "type": "string",\n                            "title": "API \u5730\u5740",\n                            "description": "\u81ea\u5b9a\u4e49 IM \u5e73\u53f0\u7684 API \u63a5\u53e3\u5730\u5740",\n                            "placeholder": "https://api.your-im.com"\n                        },\n                        "app_id": {\n                            "type": "string",\n                            "title": "\u5e94\u7528 ID",\n                            "description": "\u5728 IM \u5e73\u53f0\u521b\u5efa\u7684\u5e94\u7528 ID"\n                        },\n                        "app_secret": {\n                            "type": "string",\n                            "title": "\u5e94\u7528\u5bc6\u94a5",\n                            "format": "password",\n                            "description": "\u5e94\u7528\u7684\u5bc6\u94a5\uff0c\u8bf7\u59a5\u5584\u4fdd\u7ba1"\n                        },\n                        "features": {\n                            "type": "object",\n                            "title": "\u529f\u80fd\u914d\u7f6e",\n                            "properties": {\n                                "enable_typing": {\n                                    "type": "boolean",\n                                    "title": "\u6b63\u5728\u8f93\u5165\u63d0\u793a",\n                                    "default": True\n                                },\n                                "enable_read_receipt": {\n                                    "type": "boolean",\n                                    "title": "\u5df2\u8bfb\u56de\u6267",\n                                    "default": False\n                                },\n                                "auto_reply_offline": {\n                                    "type": "boolean",\n                                    "title": "\u79bb\u7ebf\u81ea\u52a8\u56de\u590d",\n                                    "default": True\n                                }\n                            }\n                        }\n                    },\n                    "required": ["api_endpoint", "app_id", "app_secret"]\n                },\n                \n                "setup_guide": """# \u81ea\u5b9a\u4e49 IM \u5e73\u53f0\u63a5\u5165\u6307\u5357\n\n## \u524d\u7f6e\u6761\u4ef6\n\n1. \u5df2\u6ce8\u518c\u81ea\u5b9a\u4e49 IM \u5e73\u53f0\u5f00\u53d1\u8005\u8d26\u53f7\n2. \u5df2\u521b\u5efa\u5e94\u7528\u5e76\u83b7\u53d6 App ID \u548c App Secret\n\n## \u63a5\u5165\u6b65\u9aa4\n\n### \u6b65\u9aa4\u4e00\uff1a\u914d\u7f6e Webhook\n\n\u767b\u5f55 IM \u5e73\u53f0\u540e\u53f0\uff0c\u5c06\u4ee5\u4e0b\u5730\u5740\u914d\u7f6e\u4e3a\u6d88\u606f\u56de\u8c03\u5730\u5740\uff1a\n\n'})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.a,{href:"https://your-tgo-domain.com/api/webhooks/custom-im",children:"https://your-tgo-domain.com/api/webhooks/custom-im"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'\n### \u6b65\u9aa4\u4e8c\uff1a\u586b\u5199\u914d\u7f6e\n\n\u5728\u4e0a\u65b9\u8868\u5355\u4e2d\u586b\u5199\uff1a\n- **API \u5730\u5740**\uff1aIM \u5e73\u53f0\u63d0\u4f9b\u7684 API \u63a5\u53e3\u5730\u5740\n- **\u5e94\u7528 ID**\uff1a\u521b\u5efa\u5e94\u7528\u65f6\u83b7\u53d6\u7684 App ID\n- **\u5e94\u7528\u5bc6\u94a5**\uff1a\u521b\u5efa\u5e94\u7528\u65f6\u83b7\u53d6\u7684 App Secret\n\n### \u6b65\u9aa4\u4e09\uff1a\u6d4b\u8bd5\u8fde\u63a5\n\n\u4fdd\u5b58\u914d\u7f6e\u540e\uff0c\u70b9\u51fb\u300c\u6d4b\u8bd5\u8fde\u63a5\u300d\u6309\u94ae\u9a8c\u8bc1\u914d\u7f6e\u662f\u5426\u6b63\u786e\u3002\n\n## \u652f\u6301\u7684\u6d88\u606f\u7c7b\u578b\n\n| \u7c7b\u578b | \u53d1\u9001 | \u63a5\u6536 |\n|------|------|------|\n| \u6587\u672c\u6d88\u606f | \u2705 | \u2705 |\n| \u56fe\u7247\u6d88\u606f | \u2705 | \u2705 |\n| \u6587\u4ef6\u6d88\u606f | \u2705 | \u2705 |\n| \u8bed\u97f3\u6d88\u606f | \u274c | \u2705 |\n| \u89c6\u9891\u6d88\u606f | \u274c | \u2705 |\n\n## \u5e38\u89c1\u95ee\u9898\n\n**Q: \u6d88\u606f\u53d1\u9001\u5931\u8d25\u600e\u4e48\u529e\uff1f**\n\nA: \u8bf7\u68c0\u67e5 API \u5730\u5740\u548c\u5bc6\u94a5\u662f\u5426\u6b63\u786e\uff0c\u786e\u4fdd\u7f51\u7edc\u53ef\u4ee5\u8bbf\u95ee IM \u5e73\u53f0\u3002\n\n**Q: \u5982\u4f55\u67e5\u770b\u6d88\u606f\u65e5\u5fd7\uff1f**\n\nA: \u5728 TGO \u540e\u53f0\u7684\u300c\u6e20\u9053\u7ba1\u7406\u300d\u4e2d\u53ef\u4ee5\u67e5\u770b\u6d88\u606f\u6536\u53d1\u65e5\u5fd7\u3002\n""",\n                \n                "webhook_endpoint": "/api/webhooks/custom-im",\n                \n                "capabilities": {\n                    "send_text": True,\n                    "send_image": True,\n                    "send_file": True,\n                    "send_rich_card": False,\n                    "receive_text": True,\n                    "receive_image": True,\n                    "receive_file": True,\n                    "receive_voice": True,\n                    "receive_video": True,\n                    "typing_indicator": True,\n                    "read_receipt": True\n                }\n            }\n        }\n    \n    def handle_channel_integration_configure(self, request: Dict) -> Dict:\n        """\u4fdd\u5b58\u914d\u7f6e"""\n        params = request.get("params", {})\n        self.config = params.get("config", {})\n        \n        # \u9a8c\u8bc1\u914d\u7f6e\n        api_endpoint = self.config.get("api_endpoint", "")\n        app_id = self.config.get("app_id", "")\n        app_secret = self.config.get("app_secret", "")\n        \n        if not all([api_endpoint, app_id, app_secret]):\n            return {\n                "jsonrpc": "2.0",\n                "id": request["id"],\n                "error": {\n                    "code": -32602,\n                    "message": "\u7f3a\u5c11\u5fc5\u586b\u914d\u7f6e\u9879"\n                }\n            }\n        \n        return {\n            "jsonrpc": "2.0",\n            "id": request["id"],\n            "result": {"success": True}\n        }\n    \n    def handle_channel_integration_test_connection(self, request: Dict) -> Dict:\n        """\u6d4b\u8bd5\u8fde\u63a5"""\n        api_endpoint = self.config.get("api_endpoint", "")\n        app_id = self.config.get("app_id", "")\n        app_secret = self.config.get("app_secret", "")\n        \n        try:\n            # \u8c03\u7528 IM \u5e73\u53f0\u7684\u6d4b\u8bd5\u63a5\u53e3\n            response = requests.post(\n                f"{api_endpoint}/api/test",\n                json={"app_id": app_id},\n                headers={"Authorization": f"Bearer {app_secret}"},\n                timeout=10\n            )\n            \n            if response.status_code == 200:\n                return {\n                    "jsonrpc": "2.0",\n                    "id": request["id"],\n                    "result": {\n                        "success": True,\n                        "message": "\u8fde\u63a5\u6210\u529f\uff01"\n                    }\n                }\n            else:\n                return {\n                    "jsonrpc": "2.0",\n                    "id": request["id"],\n                    "result": {\n                        "success": False,\n                        "message": f"\u8fde\u63a5\u5931\u8d25: {response.text}"\n                    }\n                }\n        except Exception as e:\n            return {\n                "jsonrpc": "2.0",\n                "id": request["id"],\n                "result": {\n                    "success": False,\n                    "message": f"\u8fde\u63a5\u9519\u8bef: {str(e)}"\n                }\n            }\n    \n    def handle_channel_integration_send_message(self, request: Dict) -> Dict:\n        """\u53d1\u9001\u6d88\u606f\u5230 IM \u5e73\u53f0"""\n        params = request.get("params", {})\n        channel_id = params.get("channel_id")\n        to = params.get("to", {})\n        message = params.get("message", {})\n        \n        api_endpoint = self.config.get("api_endpoint", "")\n        app_secret = self.config.get("app_secret", "")\n        \n        try:\n            response = requests.post(\n                f"{api_endpoint}/api/messages/send",\n                json={\n                    "to_user": to.get("id"),\n                    "message_type": message.get("type", "text"),\n                    "content": message.get("content")\n                },\n                headers={"Authorization": f"Bearer {app_secret}"},\n                timeout=30\n            )\n            \n            result = response.json()\n            \n            return {\n                "jsonrpc": "2.0",\n                "id": request["id"],\n                "result": {\n                    "success": True,\n                    "message_id": result.get("message_id")\n                }\n            }\n        except Exception as e:\n            return {\n                "jsonrpc": "2.0",\n                "id": request["id"],\n                "error": {\n                    "code": -32000,\n                    "message": f"\u53d1\u9001\u5931\u8d25: {str(e)}"\n                }\n            }\n    \n    def run(self):\n        while self.running:\n            request = read_request()\n            if request is None:\n                break\n            \n            method = request.get("method", "")\n            handler_name = f"handle_{method.replace(\'/\', \'_\')}"\n            \n            handler = getattr(self, handler_name, None)\n            if handler:\n                response = handler(request)\n            elif method == "shutdown":\n                self.running = False\n                response = {\n                    "jsonrpc": "2.0",\n                    "id": request["id"],\n                    "result": {"success": True}\n                }\n            else:\n                response = {\n                    "jsonrpc": "2.0",\n                    "id": request.get("id"),\n                    "error": {"code": -32601, "message": f"Method not found: {method}"}\n                }\n            \n            send_response(response)\n\n\nif __name__ == "__main__":\n    plugin = CustomIMPlugin()\n    plugin.run()\n'})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u793a\u4f8b\u56dbiframe-\u5e94\u7528\u63d2\u4ef6",children:"\u793a\u4f8b\u56db\uff1aiframe \u5e94\u7528\u63d2\u4ef6"}),"\n",(0,i.jsx)(e.p,{children:"\u63d0\u4f9b iframe \u5e94\u7528 URL \u7684\u7b80\u5355\u63d2\u4ef6\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"python-\u5b9e\u73b0-3",children:"Python \u5b9e\u73b0"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'#!/usr/bin/env python3\n"""\nTGO \u63d2\u4ef6\u793a\u4f8b - iframe \u5e94\u7528\n\u5728\u804a\u5929\u754c\u9762\u53f3\u4fa7\u5d4c\u5165\u5916\u90e8\u5e94\u7528\n"""\nimport sys\nimport json\n\ndef read_request():\n    line = sys.stdin.readline()\n    if not line:\n        return None\n    return json.loads(line.strip())\n\ndef send_response(response):\n    print(json.dumps(response, ensure_ascii=False), flush=True)\n\ndef handle_initialize(request):\n    return {\n        "jsonrpc": "2.0",\n        "id": request["id"],\n        "result": {\n            "name": "crm-iframe-app",\n            "version": "1.0.0",\n            "description": "CRM \u7cfb\u7edf\u5d4c\u5165\u5e94\u7528",\n            "capabilities": [\n                {\n                    "type": "sidebar_iframe",\n                    "title": "CRM \u7cfb\u7edf",\n                    "icon": "users",\n                    "url": "https://crm.example.com/tgo-embed",\n                    "width": 400\n                },\n                {\n                    "type": "sidebar_iframe",\n                    "title": "\u5de5\u5355\u7cfb\u7edf",\n                    "icon": "ticket",\n                    "url": "https://ticket.example.com/tgo-embed",\n                    "width": 350\n                }\n            ]\n        }\n    }\n\ndef handle_sidebar_iframe_config(request):\n    """\u8fd4\u56de iframe \u914d\u7f6e\u8be6\u60c5"""\n    return {\n        "jsonrpc": "2.0",\n        "id": request["id"],\n        "result": {\n            "apps": [\n                {\n                    "id": "crm",\n                    "url": "https://crm.example.com/tgo-embed",\n                    "title": "CRM \u7cfb\u7edf",\n                    "icon": "users",\n                    "width": 400,\n                    "min_width": 300,\n                    "max_width": 600,\n                    "allow_fullscreen": True,\n                    "sandbox": "allow-scripts allow-same-origin allow-forms allow-popups",\n                    "permissions": ["clipboard-read", "clipboard-write"]\n                },\n                {\n                    "id": "ticket",\n                    "url": "https://ticket.example.com/tgo-embed",\n                    "title": "\u5de5\u5355\u7cfb\u7edf",\n                    "icon": "ticket",\n                    "width": 350,\n                    "allow_fullscreen": True\n                }\n            ]\n        }\n    }\n\n# \u4f7f\u7528 TGOPlugin \u57fa\u7c7b\u8fd0\u884c\uff08\u53c2\u8003\u793a\u4f8b\u4e00\uff09\n# \u4ee5\u4e0b\u4e3a\u5904\u7406\u51fd\u6570\uff0c\u9700\u914d\u5408 TGOPlugin \u57fa\u7c7b\u4f7f\u7528\n#\n# class DataDashboardPlugin(TGOPlugin):\n#     def __init__(self):\n#         super().__init__("data-dashboard", "1.0.0")\n#     \n#     def get_capabilities(self):\n#         return PLUGIN_CAPABILITIES\n#     \n#     def handle_sidebar_iframe_config(self, params):\n#         return handle_sidebar_iframe_config({"params": params})["result"]\n#\n# if __name__ == "__main__":\n#     plugin = DataDashboardPlugin()\n#     plugin.run()\n'})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b",children:"\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b"}),"\n",(0,i.jsx)(e.h3,{id:"pluginjson",children:"plugin.json"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-json",children:'{\n  "name": "crm-customer-info",\n  "version": "1.0.0",\n  "description": "CRM \u5ba2\u6237\u4fe1\u606f\u63d2\u4ef6",\n  "author": "Your Name",\n  "homepage": "https://github.com/your-org/tgo-crm-plugin",\n  "license": "MIT",\n  \n  "runtime": {\n    "command": "python3",\n    "args": ["main.py"],\n    "working_directory": ".",\n    "env": {\n      "CRM_API_URL": "https://crm.example.com/api"\n    }\n  },\n  \n  "requirements": {\n    "python": ">=3.8",\n    "packages": ["requests>=2.28.0"]\n  }\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u6d4b\u8bd5\u811a\u672c",children:"\u6d4b\u8bd5\u811a\u672c"}),"\n",(0,i.jsx)(e.h3,{id:"test_serverpy",children:"test_server.py"}),"\n",(0,i.jsx)(e.p,{children:"\u6a21\u62df TGO \u5bbf\u4e3b\u7a0b\u5e8f\uff0c\u7528\u4e8e\u6d4b\u8bd5\u63d2\u4ef6\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'#!/usr/bin/env python3\n"""\u6a21\u62df TGO \u5bbf\u4e3b\u7a0b\u5e8f - \u6d4b\u8bd5\u63d2\u4ef6"""\nimport os\nimport socket\nimport struct\nimport json\n\nTGO_SOCKET_PATH = "/var/run/tgo/tgo.sock"\n\ndef send_message(conn, data):\n    json_bytes = json.dumps(data).encode(\'utf-8\')\n    conn.sendall(struct.pack(\'>I\', len(json_bytes)) + json_bytes)\n\ndef recv_message(conn):\n    length_bytes = conn.recv(4)\n    if not length_bytes:\n        return None\n    length = struct.unpack(\'>I\', length_bytes)[0]\n    return json.loads(conn.recv(length).decode(\'utf-8\'))\n\n# \u51c6\u5907 Socket\nos.makedirs(os.path.dirname(TGO_SOCKET_PATH), exist_ok=True)\nif os.path.exists(TGO_SOCKET_PATH):\n    os.unlink(TGO_SOCKET_PATH)\n\nserver = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)\nserver.bind(TGO_SOCKET_PATH)\nserver.listen(1)\nprint(f"[TGO \u6a21\u62df] \u76d1\u542c: {TGO_SOCKET_PATH}")\nprint("[TGO \u6a21\u62df] \u8bf7\u542f\u52a8\u63d2\u4ef6...")\n\nconn, _ = server.accept()\nprint("[TGO \u6a21\u62df] \u63d2\u4ef6\u5df2\u8fde\u63a5!")\n\n# \u63a5\u6536 register \u8bf7\u6c42\nrequest = recv_message(conn)\nprint(f"\\n=== \u6536\u5230 register ===")\nprint(json.dumps(request, indent=2, ensure_ascii=False))\n\n# \u8fd4\u56de\u6ce8\u518c\u6210\u529f\nsend_message(conn, {\n    "jsonrpc": "2.0",\n    "id": request["id"],\n    "result": {"success": True, "plugin_id": "test_001"}\n})\n\n# \u6d4b\u8bd5\u8bbf\u5ba2\u9762\u677f\u6e32\u67d3\nprint("\\n=== \u53d1\u9001 visitor_panel/render ===")\nsend_message(conn, {\n    "jsonrpc": "2.0", "id": 2,\n    "method": "visitor_panel/render",\n    "params": {"visitor_id": "v_123", "visitor": {"name": "\u6d4b\u8bd5\u7528\u6237"}}\n})\nprint(json.dumps(recv_message(conn), indent=2, ensure_ascii=False))\n\n# \u5173\u95ed\nsend_message(conn, {"jsonrpc": "2.0", "id": 99, "method": "shutdown"})\nrecv_message(conn)\nconn.close()\nserver.close()\nos.unlink(TGO_SOCKET_PATH)\nprint("\\n[TGO \u6a21\u62df] \u6d4b\u8bd5\u5b8c\u6210!")\n'})}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"\u4e0b\u4e00\u6b65",children:"\u4e0b\u4e00\u6b65"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"/plugin/protocol",children:"\u901a\u8baf\u534f\u8bae"})," - \u6df1\u5165\u4e86\u89e3\u534f\u8bae\u7ec6\u8282"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"/plugin/templates",children:"\u6a21\u7248\u89c4\u8303"})," - \u4e86\u89e3\u6240\u6709 UI \u6a21\u7248\u7c7b\u578b"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"/plugin/extension-points",children:"\u53ef\u63d2\u70b9\u8be6\u89e3"})," - \u4e86\u89e3\u6bcf\u4e2a\u53ef\u63d2\u70b9\u7684\u8be6\u7ec6\u7528\u6cd5"]}),"\n"]})]})}function u(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}}}]);